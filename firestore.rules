/**
 * Core Philosophy: This ruleset uses a combination of user-owned data trees and a global,
 * query-based security model.
 *
 * Data Structure:
 * - `/users/{userId}`: Root for private user data like profiles, settings, and themes.
 * - `/forms/{formId}`: A global collection of all forms. Each form document contains a `userId`
 *   field to denote ownership.
 *
 * Key Security Decisions:
 * - User Isolation: Users can only access documents within their own `/users/{userId}` tree.
 * - Global Forms, Private Management: Forms are stored globally to allow for public access via a direct
 *   link (`/forms/{formId}`). However, writes and deletions are strictly controlled. Users can only
 *   create forms for themselves (`request.resource.data.userId == request.auth.uid`) and can only
 *   update or delete forms they own (verified by checking the existing document's `userId`).
 * - Query-Based Listing: Instead of path-based listing (e.g., `/users/{userId}/forms`), users list
 *   their own forms by querying the global `/forms` collection `where('userId', '==', request.auth.uid)`.
 *   The rules enforce this query constraint.
 * - Public Submissions: Anyone (authenticated or anonymous) can read a public form and submit a
 *   `response` to it. Only the form's owner can view and manage the collected responses.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ------------------------------------------------------------------------
    // Helper Functions
    // ------------------------------------------------------------------------

    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    // ------------------------------------------------------------------------
    // User Data Collections (/users/{userId}/**)
    // ------------------------------------------------------------------------
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false; // Prevent listing all users
      allow create: if isOwner(userId) && request.resource.data.id == userId;
      allow update: if isOwner(userId);
      allow delete: if false; // Disallow client-side account deletion

      match /themes/{themeId} {
        allow read, write: if isOwner(userId);
      }

      match /settings/{settingId} {
        allow read, write: if isOwner(userId);
      }
    }

    // ------------------------------------------------------------------------
    // Global Forms Collection (/forms/{formId}/**)
    // ------------------------------------------------------------------------
    match /forms/{formId} {
      // Allow public GET for viewing/responding to forms.
      // This is combined with the owner-based `read` rule below.
      // Any `get` request will be allowed because `(isOwner) || (true)` is always true.
      allow get: if true;

      // Allow owners to `read` (get, list) and `write` (update, delete) their own documents.
      // This rule enables the dashboard query (`list`) to work securely, as the rules engine
      // verifies that the client's `where('userId', '==', auth.uid)` clause matches this condition.
      allow read, update, delete: if isSignedIn() && get(/databases/$(database)/documents/forms/$(formId)).data.userId == request.auth.uid;
      
      // Allow `create` separately because the document doesn't exist yet for the `get()` check above.
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;

      // --- Responses Subcollection ---
      match /responses/{responseId} {
        // Anyone can create a response (submit the form).
        allow create: if true;

        // Only the form owner can read or manage the responses.
        allow get, list, update, delete: if isSignedIn() && get(/databases/$(database)/documents/forms/$(formId)).data.userId == request.auth.uid;
      }
    }
  }
}
