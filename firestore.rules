/**
 * Core Philosophy: This ruleset uses a combination of user-owned data trees and a global,
 * query-based security model.
 *
 * Data Structure:
 * - `/users/{userId}`: Root for private user data like profiles, settings, and themes.
 * - `/forms/{formId}`: A global collection of all forms. Each form document contains a `userId`
 *   field to denote ownership.
 *
 * Key Security Decisions:
 * - User Isolation: Users can only access documents within their own `/users/{userId}` tree.
 * - Global Forms, Private Management: Forms are stored globally to allow for public access via a direct
 *   link (`/forms/{formId}`). However, writes and deletions are strictly controlled. Users can only
 *   create forms for themselves (`request.resource.data.userId == request.auth.uid`) and can only
 *   update or delete forms they own (verified by checking the existing document's `userId`).
 * - Query-Based Listing: Instead of path-based listing (e.g., `/users/{userId}/forms`), users list
 *   their own forms by querying the global `/forms` collection `where('userId', '==', request.auth.uid)`.
 *   Top-level listing of the entire `/forms` collection is disallowed.
 * - Public Submissions: Anyone (authenticated or anonymous) can read a public form and submit a
 *   `response` to it. Only the form's owner can view and manage the collected responses.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ------------------------------------------------------------------------
    // Helper Functions
    // ------------------------------------------------------------------------

    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    // ------------------------------------------------------------------------
    // User Data Collections (/users/{userId}/**)
    // ------------------------------------------------------------------------
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false; // Prevent listing all users
      allow create: if isOwner(userId) && request.resource.data.id == userId;
      allow update: if isOwner(userId);
      allow delete: if false; // Disallow client-side account deletion

      match /themes/{themeId} {
        allow read, write: if isOwner(userId);
      }

      match /settings/{settingId} {
        allow read, write: if isOwner(userId);
      }
    }

    // ------------------------------------------------------------------------
    // Global Forms Collection (/forms/{formId}/**)
    // ------------------------------------------------------------------------
    match /forms/{formId} {
      // Anyone can read a form to view and respond to it.
      allow get: if true;

      // Users can only list their own forms via a query.
      // `allow list` is implicitly false at the collection level and cannot be
      // secured by query constraints, so we rely on client-side queries.
      allow list: if false; // Explicitly deny listing the entire collection.

      // A signed-in user can create a form for themselves.
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;

      // Only the owner of the form can update or delete it.
      allow update, delete: if isSignedIn() && get(/databases/$(database)/documents/forms/$(formId)).data.userId == request.auth.uid;

      // --- Responses Subcollection ---
      match /responses/{responseId} {
        // Anyone can create a response (submit the form).
        allow create: if true;

        // Only the form owner can read or manage the responses.
        allow get, list, update, delete: if isSignedIn() && get(/databases/$(database)/documents/forms/$(formId)).data.userId == request.auth.uid;
      }
    }
  }
}
